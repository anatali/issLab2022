
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17: http://docutils.sourceforge.net/" />

    <title>Contesti-contenitori &#8212; iss22 1.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Il SonarObservable" href="SonarObservable.html" />
    <link rel="prev" title="Abilitatori di comunicazione" href="Enablers.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="contesti-contenitori">
<h1>Contesti-contenitori<a class="headerlink" href="#contesti-contenitori" title="Permalink to this headline">¶</a></h1>
<p>Nella versione attuale, ogni <a class="reference internal" href="Enablers.html#enablerasserver"><span class="std std-ref">enabler</span></a> attiva un <code class="docutils literal notranslate"><span class="pre">TCPServer</span></code> su una propria porta.</p>
<a class="reference internal image-reference" href="_images/EnablersLedSonar.PNG"><img alt="_images/EnablersLedSonar.PNG" class="align-center" src="_images/EnablersLedSonar.PNG" style="width: 70%;" /></a>
<p>Una ottimizzazione delle risorse può essere ottenuta introducendo <span class="blue">un solo TCPServer</span> per ogni nodo
computazionale.</p>
<section id="analisi-del-concetto-di-contesto">
<h2>Analisi del concetto di Contesto<a class="headerlink" href="#analisi-del-concetto-di-contesto" title="Permalink to this headline">¶</a></h2>
<p>Introdurre un solo server per nodo computazionale significa introdurre un componente con due responsabilità
principali:</p>
<ul class="simple">
<li><p>permettere che ‘client’ allocati su altri nodi computazionali possano inviare messaggi al nodo e gestire
tali messaggi a ‘livello di sistema’;</p></li>
<li><p>fungere da contenitore di componenti  capaci di gestire i messaggi a livello applicativo.</p></li>
</ul>
<p>D’ora in poi denomineremo col termine generico <code class="docutils literal notranslate"><span class="pre">Contesto</span></code> un componente di questo tipo, lasciando
indeterminata la sua natura. Ogni contesto dovrà però supportare le funzionalità indicate e quindi
soddisfare un ‘contratto’ esprimibile al solito attraverso una interfaccia</p>
<section id="icontext">
<h3>IContext<a class="headerlink" href="#icontext" title="Permalink to this headline">¶</a></h3>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">IContext</span> <span class="p">{</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addComponent</span><span class="p">(</span> <span class="n">String</span> <span class="n">name</span><span class="p">,</span> <span class="n">IApplMsgHandler</span> <span class="n">h</span><span class="p">);</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">removeComponent</span><span class="p">(</span> <span class="n">String</span> <span class="n">name</span> <span class="p">);</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">activate</span><span class="p">();</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">deactivate</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>L’assenza di metodi come <code class="docutils literal notranslate"><span class="pre">send/receive</span></code> di messaggi significa che non pensiamo al contesto
come a un supporto per comunicare, ma piuttosto come un ‘ambiente’ che fornisce queste capacità
(una volta attivato) ai componenti che contiene.</p>
<p>In questa fase dello sviluppo, cercheremo di realizzare l’idea di Contesto riusando il software sviluppato
negli SPRINT precedenti. In questa prospettiva:</p>
<ul class="simple">
<li><p>il contesto potrà essere implementato da una classe che realizza un <a class="reference internal" href="Enablers.html#enablerasserver"><span class="std std-ref">enabler</span></a>
a livello di nodo (si veda <a class="reference internal" href="#enablercontext"><span class="std std-ref">EnablerContext</span></a>) ;</p></li>
<li><p>componenti applicativi gestori dei messaggi potrano essere definiti da classi che specializzano la classe
<a class="reference internal" href="RadarSystemSupporti.html#applmsghandler"><span class="std std-ref">ApplMsgHandler</span></a>  e implementano <a class="reference internal" href="RadarSystemSupporti.html#iapplmsghandler"><span class="std std-ref">L’interfaccia IApplMsgHandler</span></a>;</p></li>
<li><p>il contesto deve reindirizzare un messaggio ad uno specifico
componente applicativo (come <a class="reference internal" href="Enablers.html#ledapplhandler"><span class="std std-ref">LedApplHandler</span></a> e <a class="reference internal" href="Enablers.html#sonarapplhandler"><span class="std std-ref">SonarApplHandler</span></a>). Questa
gestione  a ‘livello di sistema’ dei messaggi può essere delegata
a un oggetto <a class="reference internal" href="#contextmsghandler"><span class="std std-ref">ContextMsgHandler</span></a> di tipo <a class="reference internal" href="RadarSystemSupporti.html#iapplmsghandler"><span class="std std-ref">IApplMsgHandler</span></a>
che funge da anche da <strong>contenitore di componenti</strong>.</p></li>
</ul>
<a class="reference internal image-reference" href="_images/TcpContextServerSonarLed.PNG"><img alt="_images/TcpContextServerSonarLed.PNG" class="align-center" src="_images/TcpContextServerSonarLed.PNG" style="width: 50%;" /></a>
<p>In questo quadro:</p>
<p><span class="remark">il ContextMsgHandler deve sapere a quale componente è destinato un messaggio</span></p>
<p>Occorre quindi superare l’idea che un messaggio sia una String interpretabile dal
solo dal livello applicativo (si veda <a class="reference internal" href="Enablers.html#interpreti"><span class="std std-ref">Interpreti</span></a>).</p>
<p>Più specificatamente, occorre definire una estensione sulla struttura dei messaggi,
che ci darà  anche uno
<span class="blue">standard interno</span> sulla struttura delle informazioni scambiate via rete.</p>
<p>Parti di questa estensione dovranno essere interpretate dal <a class="reference internal" href="#contextmsghandler"><span class="std std-ref">ContextMsgHandler</span></a>,
che svolge il ruolo di un ‘interprete di sistema’.  La sua operazione
<code class="docutils literal notranslate"><span class="pre">elaborate(String</span> <span class="pre">message)</span></code> effettua il voluto reindirizzamento del messaggio
a uno dei componenti applicativi memorizzati.</p>
</section>
<section id="struttura-dei-messaggi-applicativi">
<span id="msgapplicativi"></span><h3>Struttura dei messaggi applicativi<a class="headerlink" href="#struttura-dei-messaggi-applicativi" title="Permalink to this headline">¶</a></h3>
<p>Introduciamo dunque una  estensione sulla struttura dei messaggi, che ci darà d’ora in poi anche uno
<span class="blue">standard interno</span> sulla struttura delle informazioni scambiate via rete:</p>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span></span>  <span class="n">msg</span><span class="p">(</span> <span class="n">MSGID</span><span class="p">,</span> <span class="n">MSGTYPE</span><span class="p">,</span> <span class="n">SENDER</span><span class="p">,</span> <span class="n">RECEIVER</span><span class="p">,</span> <span class="n">CONTENT</span><span class="p">,</span> <span class="n">SEQNUM</span> <span class="p">)</span>

<span class="o">-</span> <span class="n">MSGID</span><span class="p">:</span>    <span class="n">identificativo</span> <span class="n">del</span> <span class="n">messaggio</span>
<span class="o">-</span> <span class="n">MSGTYPE</span><span class="p">:</span>  <span class="n">tipo</span> <span class="n">del</span> <span class="nf">msg</span> <span class="p">(</span><span class="n">Dispatch</span><span class="p">,</span> <span class="n">Invitation</span><span class="p">,</span><span class="n">Request</span><span class="p">,</span><span class="n">Reply</span><span class="p">,</span><span class="n">Event</span><span class="p">)</span>
<span class="o">-</span> <span class="n">SENDER</span><span class="p">:</span>   <span class="n">nome</span> <span class="n">del</span> <span class="n">componente</span> <span class="n">che</span> <span class="n">invia</span> <span class="n">il</span> <span class="n">messaggio</span>
<span class="o">-</span> <span class="n">CONTENT</span><span class="p">:</span>  <span class="n">contenuto</span> <span class="nf">applicativo</span> <span class="p">(</span><span class="n">payload</span><span class="p">)</span> <span class="n">del</span> <span class="n">messaggio</span>
<span class="o">-</span> <span class="n">RECEIVER</span><span class="p">:</span> <span class="n">nome</span> <span class="n">del</span> <span class="n">componente</span> <span class="n">chi</span> <span class="n">riceve</span> <span class="n">il</span> <span class="n">messaggio</span>
<span class="o">-</span> <span class="n">SEQNUM</span><span class="p">:</span>   <span class="n">numero</span> <span class="n">di</span> <span class="n">sequenza</span> <span class="n">del</span> <span class="n">messaggio</span>
</pre></div>
</div>
</div></blockquote>
<p>Come già discusso in <a class="reference internal" href="CostruireSoftware.html#terminologia-di-riferimento"><span class="std std-ref">Terminologia di riferimento</span></a>,
i messaggi scambiati sono logicamente suddivisi in diverse categorie:</p>
<table class="colwidths-given docutils align-default" style="width: 100%">
<colgroup>
<col style="width: 70%" />
<col style="width: 30%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><ul class="simple">
<li><p><span class="blue">dispatch</span>: un messaggio inviato a un preciso destinatario senza attesa  di una risposta
(in modo detto anche  <cite>fire-and-forget</cite>);</p></li>
<li><p><span class="blue">invitation</span>: un messaggio inviato a un preciso destinatario aspettandosi un ‘ack’ da parte di questi;</p></li>
<li><p><span class="blue">request</span>: un messaggio inviato a un preciso destinatario aspettandosi da parte di questi una
<span class="blue">response/reply</span> logicamente correlata alla richiesta;</p></li>
<li><p><span class="blue">event</span>: un messaggio inviato a chiunque sia in grado di elaborarlo.</p></li>
</ul>
</td>
<td><a class="reference internal image-reference" href="_images/legendMessages.PNG"><img alt="_images/legendMessages.PNG" class="align-center" src="_images/legendMessages.PNG" style="width: 80%;" /></a>
</td>
</tr>
</tbody>
</table>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">enum</span> <span class="n">ApplMessageType</span><span class="p">{</span>
    <span class="n">event</span><span class="p">,</span> <span class="n">dispatch</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">reply</span><span class="p">,</span> <span class="n">invitation</span>
<span class="p">}</span>
</pre></div>
</div>
<section id="rappresentazione-dei-messaggi">
<h4>Rappresentazione dei messaggi<a class="headerlink" href="#rappresentazione-dei-messaggi" title="Permalink to this headline">¶</a></h4>
<p>La rappresentazione in forma di String dei messaggi seguirà le regole della sitassi <a class="reference external" href="https://it.wikipedia.org/wiki/Prolog">Prolog</a>.
In particolare:</p>
<ul class="simple">
<li><p>gli identificatori <code class="docutils literal notranslate"><span class="pre">MSGID,SENDER,RECEIVER</span></code> sono espressi da <strong>atomi</strong> Prolog formati da lettere minuscole;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">MSGTYPE</span></code> è un atomo prefissato (al momento) tra i seguenti: <code class="docutils literal notranslate"><span class="pre">dispatch,</span> <span class="pre">request,</span> <span class="pre">reply</span></code>;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">CONTENT</span></code> è un <strong>termine</strong> Prolog;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SEQNUM</span></code> è un intero.</p></li>
</ul>
<p>Esempi di messaggi:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">msg</span><span class="p">(</span><span class="n">sonarcmd</span><span class="p">,</span><span class="n">dispatch</span><span class="p">,</span><span class="n">controller</span><span class="p">,</span><span class="n">sonar</span><span class="p">,</span><span class="n">deactivate</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
<span class="n">msg</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span><span class="n">dispatch</span><span class="p">,</span><span class="n">controller</span><span class="p">,</span><span class="n">led</span><span class="p">,</span><span class="n">eecute</span><span class="p">(</span><span class="n">turnOn</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span>
<span class="n">msg</span><span class="p">(</span><span class="n">req</span><span class="p">,</span><span class="n">request</span><span class="p">,</span><span class="n">main</span><span class="p">,</span><span class="n">sonar</span><span class="p">,</span><span class="n">getDistance</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="n">msg</span><span class="p">(</span><span class="n">req</span><span class="p">,</span><span class="n">request</span><span class="p">,</span><span class="n">main</span><span class="p">,</span><span class="n">led</span><span class="p">,</span><span class="n">info</span><span class="p">(</span><span class="n">getState</span><span class="p">),</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="iapplmessage">
<h4>IApplMessage<a class="headerlink" href="#iapplmessage" title="Permalink to this headline">¶</a></h4>
<p>Una appropriata interfaccia definisce i metodi per l’accesso ai diversi campi del messaggio
e i predicati che permettono di testarne il tipo:</p>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span></span> <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">IApplMessage</span> <span class="p">{</span>
  <span class="kd">public</span> <span class="n">String</span> <span class="nf">msgId</span><span class="p">();</span>
  <span class="kd">public</span> <span class="n">String</span> <span class="nf">msgType</span><span class="p">();</span>
  <span class="kd">public</span> <span class="n">String</span> <span class="nf">msgSender</span><span class="p">();</span>
  <span class="kd">public</span> <span class="n">String</span> <span class="nf">msgReceiver</span><span class="p">();</span>
  <span class="kd">public</span> <span class="n">String</span> <span class="nf">msgContent</span><span class="p">();</span>
  <span class="kd">public</span> <span class="n">String</span> <span class="nf">msgNum</span><span class="p">();</span>
  <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isDispatch</span><span class="p">();</span>
  <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isRequest</span><span class="p">();</span>
  <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isReply</span><span class="p">();</span>
  <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isEvent</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
</section>
<section id="il-problema-delle-risposte">
<h4>Il problema delle risposte<a class="headerlink" href="#il-problema-delle-risposte" title="Permalink to this headline">¶</a></h4>
<p>Nella versione strutturata dei messaggi, il tipo di messaggio  <code class="docutils literal notranslate"><span class="pre">reply</span></code>
denota che il messaggio è una <strong>risposta</strong>, relativa a una precedente <em>richiesta</em> (<code class="docutils literal notranslate"><span class="pre">request</span></code>).</p>
<p>L’attuale implementazione dell’invio di una richiesta è fatta in modo <strong>sincrono</strong> dal metodo <code class="docutils literal notranslate"><span class="pre">request</span></code> di
<a class="reference internal" href="RadarSystemSupporti.html#tcpconnection"><span class="std std-ref">TcpConnection</span></a> (che implementa <a class="reference internal" href="RadarSystemProdottiAnalisi.html#interaction2021"><span class="std std-ref">Interaction2021</span></a>).
Ciò significa che  il componente che effettua una richiesta usando il metodo <code class="docutils literal notranslate"><span class="pre">request</span></code>
rimane attualmente in attesa della risposta qualificata come <code class="docutils literal notranslate"><span class="pre">reply</span></code>.</p>
<p>Ma in futuro si può pensare di inviare richieste in modo <strong>asincrono</strong>, cioè senza aspettare
subito la risposta.</p>
<p>In questo scenario, un componente potrebbe inviare più richieste a uno o più destinatari
e gestire poi le risposte man mano arriveranno, in un ordine qualsiasi.
Occorre quindi che tale componente possa sapere, quando riceve una <code class="docutils literal notranslate"><span class="pre">reply</span></code>, a quale richiesta
corrisponde.</p>
<p>Osserviamo che un problema del genere si pone anche nel sistema attuale, in quanto un componente
potrebbe inviare più richieste a uno stesso destinatario invocando
il metodo <code class="docutils literal notranslate"><span class="pre">request</span></code> di <a class="reference internal" href="RadarSystemSupporti.html#tcpconnection"><span class="std std-ref">TcpConnection</span></a> all’interno di un Thread.
In generale infatti, non si può assumere che il destinatario risponda in modo FIFO a due richieste
che provengono dallo stesso componente.</p>
</section>
</section>
<section id="lo-sprint4">
<h3>Lo SPRINT4<a class="headerlink" href="#lo-sprint4" title="Permalink to this headline">¶</a></h3>
<p>La realizzazione di sistemi in cui ogni nodo computazionale
può ospitare un Contesto sarà l’obiettivo dello SPRINT4 e del progetto <code class="docutils literal notranslate"><span class="pre">it.unibo.radarSystem22_4</span></code>.</p>
<p>In questo progetto inseriremo sia il software di competenza dei <strong>System Designer</strong>
(nel package <code class="docutils literal notranslate"><span class="pre">it.unibo.radarSystem22_4.comm</span></code>) sia il software di competenza degli <strong>Application Designer</strong>.
(nel package <code class="docutils literal notranslate"><span class="pre">it.unibo.radarSystem22_4.appl</span></code>).</p>
<p>In una fase successiva, torneremo a scorporare la parte di sistema, ma lo faremo dopo avere introdotto
gli <a class="reference internal" href="Attori.html"><span class="doc">Attori</span></a>.</p>
<p>Come in precedenza, il progetto si avvarrà della libreria <code class="docutils literal notranslate"><span class="pre">it.unibo.radarSystem22.domain-1.0</span></code> che contiene
il software relativo al dominio, che ovviamente non cambia.</p>
</section>
</section>
<section id="sprint4-il-progetto-del-systemdesigner">
<h2>SPRINT4: il progetto del SystemDesigner<a class="headerlink" href="#sprint4-il-progetto-del-systemdesigner" title="Permalink to this headline">¶</a></h2>
<section id="la-classe-applmessage">
<span id="applmessage"></span><h3>La classe ApplMessage<a class="headerlink" href="#la-classe-applmessage" title="Permalink to this headline">¶</a></h3>
<p>La classe <code class="docutils literal notranslate"><span class="pre">ApplMessage</span></code> fornisce metodi per la costruzione e la gestione di messaggi organizzati
nel modo descritto.</p>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span></span> <span class="kd">public</span> <span class="kd">class</span> <span class="nc">ApplMessage</span> <span class="kd">implements</span> <span class="n">IApplMessage</span><span class="p">{</span>
  <span class="kd">protected</span> <span class="n">String</span> <span class="n">msgId</span>       <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
  <span class="kd">protected</span> <span class="n">String</span> <span class="n">msgType</span>     <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="kd">protected</span> <span class="n">String</span> <span class="n">msgSender</span>   <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
  <span class="kd">protected</span> <span class="n">String</span> <span class="n">msgReceiver</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
  <span class="kd">protected</span> <span class="n">String</span> <span class="n">msgContent</span>  <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
  <span class="kd">protected</span> <span class="kt">int</span> <span class="n">msgNum</span>         <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kd">public</span> <span class="nf">ApplMessage</span><span class="p">(</span> <span class="n">String</span> <span class="n">MSGID</span><span class="p">,</span> <span class="n">String</span> <span class="n">MSGTYPE</span><span class="p">,</span> <span class="n">String</span> <span class="n">SENDER</span><span class="p">,</span>
        <span class="n">String</span> <span class="n">RECEIVER</span><span class="p">,</span> <span class="n">String</span> <span class="n">CONTENT</span><span class="p">,</span> <span class="n">String</span> <span class="n">SEQNUM</span> <span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
  <span class="p">}</span>
  <span class="kd">public</span> <span class="nf">ApplMessage</span><span class="p">(</span> <span class="n">String</span> <span class="n">msg</span> <span class="p">)</span> <span class="p">{</span>
    <span class="n">Struct</span> <span class="n">msgStruct</span> <span class="o">=</span> <span class="p">(</span><span class="n">Struct</span><span class="p">)</span> <span class="n">Term</span><span class="p">.</span><span class="na">createTerm</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
    <span class="n">setFields</span><span class="p">(</span><span class="n">msgStruct</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="kd">public</span> <span class="n">String</span> <span class="nf">msgId</span><span class="p">()</span> <span class="p">{</span>   <span class="k">return</span> <span class="n">msgId</span><span class="p">;</span> <span class="p">}</span>
  <span class="kd">public</span> <span class="n">String</span> <span class="nf">msgType</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">msgType</span><span class="p">;</span> <span class="p">}</span>
  <span class="kd">public</span> <span class="n">String</span> <span class="nf">msgSender</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">msgSender</span><span class="p">;</span> <span class="p">}</span>
  <span class="kd">public</span> <span class="n">String</span> <span class="nf">msgReceiver</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">msgReceiver</span><span class="p">;</span>  <span class="p">}</span>
  <span class="kd">public</span> <span class="n">String</span> <span class="nf">msgContent</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">msgContent</span><span class="p">;</span>  <span class="p">}</span>
  <span class="kd">public</span> <span class="n">String</span> <span class="nf">msgNum</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="s">&quot;&quot;</span> <span class="o">+</span> <span class="n">msgNum</span><span class="p">;</span> <span class="p">}</span>
  <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isEvent</span><span class="p">(){</span>
    <span class="k">return</span> <span class="n">msgType</span> <span class="o">==</span> <span class="n">ApplMessageType</span><span class="p">.</span><span class="na">event</span><span class="p">.</span><span class="na">toString</span><span class="p">();</span> <span class="p">}</span>
  <span class="p">...</span>
  <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="p">()</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<p>La classe si avvale del supporto del <a class="reference external" href="http://amsacta.unibo.it/5450/7/tuprolog-guide.pdf">tuProlog</a> per il passaggio della rapprresentazione
in forma di String (<code class="docutils literal notranslate"><span class="pre">msg</span></code>) a una rappresentazione interna manipolabile da programma:</p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">Struct</span> <span class="pre">msgStruct</span> <span class="pre">=</span> <span class="pre">(Struct)</span> <span class="pre">Term.createTerm(msg);</span></code></p>
</div></blockquote>
<section id="il-metodo-setfields">
<h4>Il metodo setFields<a class="headerlink" href="#il-metodo-setfields" title="Permalink to this headline">¶</a></h4>
<p>Il metodo <strong>setFields</strong> definito nella classe trasforma il messaggio espresso come termine Prolog
nell’insieme dei campi in forma di String.</p>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">private</span> <span class="kt">void</span> <span class="nf">setFields</span><span class="p">(</span> <span class="n">Struct</span> <span class="n">msgStruct</span> <span class="p">)</span> <span class="p">{</span>
    <span class="n">msgId</span> <span class="o">=</span> <span class="n">msgStruct</span><span class="p">.</span><span class="na">getArg</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="na">toString</span><span class="p">();</span>
    <span class="n">msgType</span> <span class="o">=</span> <span class="n">msgStruct</span><span class="p">.</span><span class="na">getArg</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="na">toString</span><span class="p">();</span>
    <span class="n">msgSender</span> <span class="o">=</span> <span class="n">msgStruct</span><span class="p">.</span><span class="na">getArg</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="na">toString</span><span class="p">();</span>
    <span class="n">msgReceiver</span>  <span class="o">=</span> <span class="n">msgStruct</span><span class="p">.</span><span class="na">getArg</span><span class="p">(</span><span class="mi">3</span><span class="p">).</span><span class="na">toString</span><span class="p">();</span>
    <span class="n">msgContent</span>  <span class="o">=</span> <span class="n">msgStruct</span><span class="p">.</span><span class="na">getArg</span><span class="p">(</span><span class="mi">4</span><span class="p">).</span><span class="na">toString</span><span class="p">();</span>
    <span class="n">msgNum</span>  <span class="o">=</span> <span class="n">Integer</span><span class="p">.</span><span class="na">parseInt</span><span class="p">(</span><span class="n">msgStruct</span><span class="p">.</span><span class="na">getArg</span><span class="p">(</span><span class="mi">5</span><span class="p">).</span><span class="na">toString</span><span class="p">());</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
</section>
</section>
<section id="perche-prolog">
<h3>Perchè Prolog?<a class="headerlink" href="#perche-prolog" title="Permalink to this headline">¶</a></h3>
<p>La scelta di rappresentare i messaggi come <em>termini Prolog</em> permette di sfruttare il meccanisimo
della <strong>unificazione sintattica</strong> per accedere alle informazioni contenute nel messaggio.</p>
<p>Ad esempio, consideriamo il seguente messaggio in forma di String:</p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">msg(</span> <span class="pre">cmd,</span> <span class="pre">dispatch,</span> <span class="pre">main,</span> <span class="pre">led,</span> <span class="pre">turn(off),</span> <span class="pre">1)</span></code></p>
</div></blockquote>
<p id="accesso-al-payload-usando-prolog">Volendo accedere al payload del messaggio, possiamo definire il seguente codice (come
<em>TestUnit</em>, nel file <code class="docutils literal notranslate"><span class="pre">it.unibo.radarSystem22_4.prolog.TestProlog</span></code>):</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestProlog</span> <span class="p">{</span>
  <span class="kd">private</span> <span class="n">String</span> <span class="n">cmd</span><span class="p">;</span>
  <span class="kd">private</span> <span class="n">Struct</span> <span class="n">cmdAsTerm</span><span class="p">;</span>

<span class="nd">@Before</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUp</span><span class="p">()</span> <span class="p">{</span>
       <span class="n">cmd</span>       <span class="o">=</span> <span class="s">&quot;msg( cmd, dispatch, main, led, turn(off), 1)&quot;</span><span class="p">;</span>
       <span class="n">cmdAsTerm</span> <span class="o">=</span> <span class="p">(</span><span class="n">Struct</span><span class="p">)</span> <span class="n">Term</span><span class="p">.</span><span class="na">createTerm</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>
      <span class="nd">@Test</span>
      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test0</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">Struct</span> <span class="n">payload</span>   <span class="o">=</span> <span class="p">(</span><span class="n">Struct</span><span class="p">)</span> <span class="n">cmdAsTerm</span><span class="p">.</span><span class="na">getArg</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
          <span class="n">assertEquals</span><span class="p">(</span> <span class="n">payload</span><span class="p">.</span><span class="na">toString</span><span class="p">(),</span> <span class="s">&quot;turn(off)&quot;</span><span class="p">);</span>
          <span class="n">Term</span> <span class="n">onOff</span>       <span class="o">=</span> <span class="n">payload</span><span class="p">.</span><span class="na">getArg</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
          <span class="n">assertEquals</span><span class="p">(</span> <span class="n">onOff</span><span class="p">.</span><span class="na">toString</span><span class="p">(),</span> <span class="s">&quot;off&quot;</span><span class="p">);</span>
      <span class="p">}</span>
</pre></div>
</div>
<p>Ma possiamo anche usare l’unificazione attivando la <a class="reference external" href="http://amsacta.unibo.it/5450/7/tuprolog-guide.pdf">tuProlog</a>-engine:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testUnify</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">Prolog</span> <span class="n">pengine</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Prolog</span><span class="p">();</span>
  <span class="n">String</span> <span class="n">cmdTemplate</span> <span class="o">=</span> <span class="s">&quot;msg( cmd, MSGTYPE, main, led, turn(X), 1)&quot;</span><span class="p">;</span>
  <span class="n">String</span> <span class="n">goal</span>      <span class="o">=</span> <span class="n">cmdAsTerm</span><span class="o">+</span><span class="s">&quot;=&quot;</span><span class="o">+</span><span class="n">cmdTemplate</span><span class="p">;</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="n">SolveInfo</span> <span class="n">sol</span> <span class="o">=</span> <span class="n">pengine</span><span class="p">.</span><span class="na">solve</span><span class="p">(</span> <span class="n">goal</span><span class="o">+</span><span class="s">&quot;.&quot;</span> <span class="p">);</span>
    <span class="n">Term</span> <span class="n">msgType</span> <span class="o">=</span> <span class="n">sol</span><span class="p">.</span><span class="na">getVarValue</span><span class="p">(</span><span class="s">&quot;MSGTYPE&quot;</span><span class="p">);</span>
    <span class="n">assertEquals</span><span class="p">(</span> <span class="n">msgType</span><span class="p">.</span><span class="na">toString</span><span class="p">(),</span> <span class="s">&quot;dispatch&quot;</span><span class="p">);</span>
    <span class="n">Term</span> <span class="n">data</span> <span class="o">=</span> <span class="n">sol</span><span class="p">.</span><span class="na">getVarValue</span><span class="p">(</span><span class="s">&quot;X&quot;</span><span class="p">);</span>
    <span class="n">assertEquals</span><span class="p">(</span> <span class="n">data</span><span class="p">.</span><span class="na">toString</span><span class="p">(),</span> <span class="s">&quot;off&quot;</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span> <span class="n">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span> <span class="p">...}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Sono evidentemente possibili molte altre forme di rappresentazione interna, tra cui <a class="reference external" href="https://it.wikipedia.org/wiki/JavaScript_Object_Notation">Json</a>.</p>
<section id="estensione-della-interfaccia-iapplmsghandler">
<span id="iapplmsghandleresteso"></span><h4>Estensione della interfaccia <a class="reference internal" href="RadarSystemSupporti.html#iapplmsghandler"><span class="std std-ref">IApplMsgHandler</span></a><a class="headerlink" href="#estensione-della-interfaccia-iapplmsghandler" title="Permalink to this headline">¶</a></h4>
<p>Provvediamo a modificare il contratto relativo ai gestori dei messaggi di
livello applicativo che sono ora di tipo <a class="reference internal" href="#applmessage"><span class="std std-ref">ApplMessage</span></a>.</p>
<div class="highlight-Java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">IApplMsgHandler</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">elaborate</span><span class="p">(</span> <span class="n">IApplMessage</span> <span class="n">message</span><span class="p">,</span> <span class="n">Interaction2021</span> <span class="n">conn</span> <span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p><span class="remark">messaggi standard di sistema come IApplMessage</span></p>
<ul>
<li><p>D’ora in poi il metodo <code class="docutils literal notranslate"><span class="pre">elaborate</span></code> con argomento <a class="reference internal" href="#iapplmessage"><span class="std std-ref">IApplMessage</span></a> diventerà il metodo di riferimento
per la gestione dei messaggi. In altre parole, tutte le nostre applicazioni distribuite
invieranno messaggi della forma:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">msg</span><span class="p">(</span> <span class="n">MSGID</span><span class="p">,</span> <span class="n">MSGTYPE</span><span class="p">,</span> <span class="n">SENDER</span><span class="p">,</span> <span class="n">RECEIVER</span><span class="p">,</span> <span class="n">CONTENT</span><span class="p">,</span> <span class="n">SEQNUM</span> <span class="p">)</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="estensione-della-interfaccia-iapplintepreter">
<h4>Estensione della interfaccia <a class="reference internal" href="Enablers.html#iapplintepreternoctx"><span class="std std-ref">IApplIntepreter</span></a><a class="headerlink" href="#estensione-della-interfaccia-iapplintepreter" title="Permalink to this headline">¶</a></h4>
<p>In modo analogo, modifichiamo il contratto relativo alla interpretazione dei messaggi:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">IApplIntepreter</span> <span class="p">{</span>
   <span class="kd">public</span> <span class="n">String</span> <span class="nf">elaborate</span><span class="p">(</span> <span class="n">IApplMessage</span> <span class="n">message</span> <span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="modifica-della-classe-applmsghandler">
<h4>Modifica della classe <a class="reference internal" href="RadarSystemSupporti.html#applmsghandler"><span class="std std-ref">ApplMsgHandler</span></a><a class="headerlink" href="#modifica-della-classe-applmsghandler" title="Permalink to this headline">¶</a></h4>
<p>Di conseguenza, introduciamo nella classe astratta <a class="reference internal" href="RadarSystemSupporti.html#applmsghandler"><span class="std std-ref">ApplMsgHandler</span></a>
la specifica del metodo</p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">abstract</span>&#160; <span class="pre">elaborate(</span> <span class="pre">IApplMessage</span> <span class="pre">message,</span> <span class="pre">Interaction2021</span> <span class="pre">conn</span> <span class="pre">)</span></code></p>
</div></blockquote>
<p>che dovrà essere definito dalle classi specializzate.</p>
<section id="metodo-preparereply">
<span id="preparereply"></span><h5>Metodo <code class="docutils literal notranslate"><span class="pre">prepareReply</span></code><a class="headerlink" href="#metodo-preparereply" title="Permalink to this headline">¶</a></h5>
<p>Per associare le risposte alle richieste, viene introdotto (nella classe <code class="docutils literal notranslate"><span class="pre">CommUtils</span></code>) il  metodo <code class="docutils literal notranslate"><span class="pre">prepareReply</span></code> che
generare un messaggio strutturato <code class="docutils literal notranslate"><span class="pre">msg/6</span></code> tale che:</p>
<ul class="simple">
<li><p>l’identificativo del messaggio di risposta sia l’identificativo del messaggio di richiesta;</p></li>
<li><p>l’identificativo del destinatario sia l’identificativo del mittente della richiesta.</p></li>
</ul>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">protected</span> <span class="n">ApplMessage</span> <span class="nf">prepareReply</span><span class="p">(</span><span class="n">IApplMessage</span> <span class="n">message</span><span class="p">,</span> <span class="n">String</span> <span class="n">answer</span><span class="p">)</span> <span class="p">{</span>
<span class="n">String</span> <span class="n">payload</span> <span class="o">=</span> <span class="n">message</span><span class="p">.</span><span class="na">msgContent</span><span class="p">();</span>
<span class="n">String</span> <span class="n">sender</span>  <span class="o">=</span> <span class="n">message</span><span class="p">.</span><span class="na">msgSender</span><span class="p">();</span>
<span class="n">String</span> <span class="n">receiver</span><span class="o">=</span> <span class="n">message</span><span class="p">.</span><span class="na">msgReceiver</span><span class="p">();</span>
<span class="n">String</span> <span class="n">reqId</span>   <span class="o">=</span> <span class="n">message</span><span class="p">.</span><span class="na">msgId</span><span class="p">();</span>
<span class="n">ApplMessage</span> <span class="n">reply</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span> <span class="n">message</span><span class="p">.</span><span class="na">isRequest</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
     <span class="n">reply</span> <span class="o">=</span> <span class="n">CommUtils</span><span class="p">.</span><span class="na">buildReply</span><span class="p">(</span>
        <span class="n">receiver</span><span class="p">,</span><span class="n">reqId</span><span class="p">,</span><span class="n">answer</span><span class="p">,</span><span class="n">message</span><span class="p">.</span><span class="na">msgSender</span><span class="p">());</span>
  <span class="p">}</span><span class="k">else</span> <span class="p">{</span> <span class="c1">//DEFENSIVE</span>
    <span class="n">ColorsOut</span><span class="p">.</span><span class="na">outerr</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="s">&quot; | ApplMsgHandler prepareReply ERROR...&quot;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">reply</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="abilitatore-di-contesto">
<span id="iapplintepreteresteso"></span><h3>Abilitatore di contesto<a class="headerlink" href="#abilitatore-di-contesto" title="Permalink to this headline">¶</a></h3>
<p>Scopo primario del contesto è fornire ai componenti appicativi di un nodo la capacità
di inviare e ricevere messaggi attraverso l’uso di un protocollo di comunicazione.</p>
<p>Se ci limitassimo all’uso del solo TCP, potremmo introdurre una classe
<code class="docutils literal notranslate"><span class="pre">TcpContextServer</span></code> che implementa <a class="reference internal" href="#icontext">IContext</a> come specializzazione del <a class="reference internal" href="RadarSystemSupporti.html#tcpserver"><span class="std std-ref">TcpServer</span></a>,
legando il campo <code class="docutils literal notranslate"><span class="pre">userDefHandler</span></code> a un gestore di messaggi
(il  <a class="reference internal" href="#contextmsghandler">ContextMsgHandler</a> ) che ha il compito
di reindirizzare messaggi di forma <code class="docutils literal notranslate"><span class="pre">msg(MSGID,MSGTYPE,SENDER,RECEIVER,CONTENT,SEQNUM)</span></code>
ad uno specifico gestore applicativo, sulla base dell’attributo  <code class="docutils literal notranslate"><span class="pre">RECEIVER</span></code>.</p>
<a class="reference internal image-reference" href="_images/MessageHandlers.PNG"><img alt="_images/MessageHandlers.PNG" class="align-center" src="_images/MessageHandlers.PNG" style="width: 70%;" /></a>
<p>Ma poichè nostro intento è anche quello di permettere comunicazioni basate su diversi tipi
di protocollo, introduciamo invece una classe  <code class="docutils literal notranslate"><span class="pre">EnablerContext</span></code>.</p>
<section id="enablercontext">
<h4>EnablerContext<a class="headerlink" href="#enablercontext" title="Permalink to this headline">¶</a></h4>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">EnablerContext</span>  <span class="kd">implements</span> <span class="n">IContext</span> <span class="p">{</span>
<span class="kd">protected</span> <span class="n">IContextMsgHandler</span> <span class="n">ctxMsgHandler</span><span class="p">;</span>
<span class="kd">protected</span> <span class="kt">boolean</span> <span class="n">isactive</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<span class="kd">protected</span> <span class="n">String</span> <span class="n">name</span><span class="p">;</span>
<span class="kd">protected</span> <span class="n">ProtocolType</span> <span class="n">protocol</span><span class="p">;</span>
<span class="kd">protected</span> <span class="n">TcpServer</span> <span class="n">serverTcp</span><span class="p">;</span>
<span class="kd">protected</span> <span class="n">UdpServer</span> <span class="n">serverUdp</span><span class="p">;</span>

<span class="kd">public</span> <span class="nf">EnablerContext</span><span class="p">(</span> <span class="n">String</span> <span class="n">name</span><span class="p">,</span>
  <span class="n">String</span> <span class="n">port</span><span class="p">,</span><span class="n">ProtocolType</span> <span class="n">protocol</span><span class="p">,</span><span class="n">IContextMsgHandler</span> <span class="n">handler</span><span class="p">){</span>
    <span class="n">ctxMsgHandler</span> <span class="o">=</span> <span class="n">handler</span><span class="p">;</span>
    <span class="p">...</span>
    <span class="n">setServerSupport</span><span class="p">(</span> <span class="n">port</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">handler</span>  <span class="p">);</span>
<span class="p">}</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">addComponent</span><span class="p">(</span> <span class="n">String</span> <span class="n">devname</span><span class="p">,</span> <span class="n">IApplMsgHandler</span> <span class="n">h</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">ctxMsgHandler</span><span class="p">.</span><span class="na">addComponent</span><span class="p">(</span><span class="n">devname</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>
<span class="p">}</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">activate</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">switch</span><span class="p">(</span> <span class="n">protocol</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">tcp</span> <span class="p">:</span>  <span class="p">{</span> <span class="n">serverTcp</span><span class="p">.</span><span class="na">activate</span><span class="p">();</span><span class="k">break</span><span class="p">;}</span>
    <span class="k">case</span> <span class="n">udp</span><span class="p">:</span>   <span class="p">{</span> <span class="n">serverUdp</span><span class="p">.</span><span class="na">activate</span><span class="p">();</span><span class="k">break</span><span class="p">;}</span>
    <span class="k">default</span><span class="p">:</span> <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">isactive</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="_images/EnablerContext.PNG"><img alt="_images/EnablerContext.PNG" class="align-center" src="_images/EnablerContext.PNG" style="width: 70%;" /></a>
</section>
</section>
<section id="il-gestore-di-sistema-dei-messaggi">
<span id="contextmsghandler"></span><h3>Il gestore di sistema dei messaggi<a class="headerlink" href="#il-gestore-di-sistema-dei-messaggi" title="Permalink to this headline">¶</a></h3>
<p>Il gestore dei sistema dei messaggi (eseguito all’interno di <a class="reference internal" href="RadarSystemSupporti.html#tcpconnection"><span class="std std-ref">TcpConnection</span></a> o equivalente)
attua il reindirizzamento del messaggio, consultando una mappa
interna che associa un <strong>identificativo univoco</strong> (il nome del destinatario) a un handler applicativo.</p>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ContextMsgHandler</span> <span class="kd">extends</span> <span class="n">IApplMsgHandler</span><span class="p">{</span>
<span class="kd">private</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">IApplMsgHandler</span><span class="o">&gt;</span> <span class="n">handlerMap</span> <span class="o">=</span>
                         <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">IApplMsgHandler</span><span class="o">&gt;</span><span class="p">();</span>
  <span class="kd">public</span> <span class="nf">ContextMsgHandler</span><span class="p">(</span><span class="n">String</span> <span class="n">name</span><span class="p">)</span> <span class="p">{</span> <span class="kd">super</span><span class="p">(</span><span class="n">name</span><span class="p">);</span> <span class="p">}</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">elaborate</span><span class="p">(</span><span class="n">String</span> <span class="n">message</span><span class="p">,</span><span class="n">Interaction2021</span> <span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//msg( MSGID, MSGTYPE, SENDER, RECEIVER, CONTENT, SEQNUM )</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="n">ApplMessage</span> <span class="n">msg</span>  <span class="o">=</span> <span class="k">new</span> <span class="n">ApplMessage</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
      <span class="n">elaborate</span><span class="p">(</span> <span class="n">msg</span><span class="p">,</span> <span class="n">conn</span> <span class="p">);</span>
    <span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
  <span class="p">}</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">elaborate</span><span class="p">(</span><span class="n">ApplMessage</span> <span class="n">msg</span><span class="p">,</span><span class="n">Interaction2021</span> <span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">String</span> <span class="n">dest</span>       <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="na">msgReceiver</span><span class="p">();</span>
    <span class="n">IApplMsgHandler</span> <span class="n">h</span> <span class="o">=</span> <span class="n">handlerMap</span><span class="p">.</span><span class="na">get</span><span class="p">(</span> <span class="n">dest</span> <span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">dest</span><span class="o">!=</span><span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span> <span class="n">msg</span><span class="p">.</span><span class="na">isReply</span><span class="p">())</span> <span class="p">)</span>
      <span class="n">h</span><span class="p">.</span><span class="na">elaborate</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="na">msgContent</span><span class="p">(),</span> <span class="n">conn</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addComponent</span><span class="p">(</span> <span class="n">String</span> <span class="n">name</span><span class="p">,</span> <span class="n">IApplMsgHandler</span> <span class="n">h</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">handlerMap</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">removeComponent</span><span class="p">(</span> <span class="n">String</span> <span class="n">name</span> <span class="p">)</span> <span class="p">{</span>
    <span class="n">handlerMap</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span> <span class="n">name</span> <span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<section id="verso-gli-attori">
<h4>Verso gli attori<a class="headerlink" href="#verso-gli-attori" title="Permalink to this headline">¶</a></h4>
<p>I componenti di tipo <a class="reference internal" href="RadarSystemSupporti.html#iapplmsghandler"><span class="std std-ref">IApplMsgHandler</span></a>:</p>
<ul class="simple">
<li><p><span class="remark">sono POJO gestori di messaggi</span></p></li>
<li><p><span class="remark">acquisiscono dal contesto la capacità di comunicazione</span></p></li>
</ul>
<p>I componenti applicativi che gestiscono messaggi potrebbero non essere più POJO,
ma enti attivi, denominati <strong>attori</strong>, dotati essi stessi di una coda di messaggi in ingresso:</p>
<a class="reference internal image-reference" href="_images/ContestiEComponenti.PNG"><img alt="_images/ContestiEComponenti.PNG" class="align-center" src="_images/ContestiEComponenti.PNG" style="width: 80%;" /></a>
<p>La trasformazione di un componente-gestore in attore sarà introdotta nella sezione <a class="reference internal" href="Attori.html"><span class="doc">Attori</span></a>.</p>
</section>
</section>
</section>
<section id="sprint4-il-progetto-dell-applicationdesigner">
<h2>SPRINT4: il progetto dell’ ApplicationDesigner<a class="headerlink" href="#sprint4-il-progetto-dell-applicationdesigner" title="Permalink to this headline">¶</a></h2>
<p>Ridefinizione degli handler</p>
<p>All’interno di ogni handler applicativo, occorre ora definire il codice del metodo <cite>elaborate</cite>
di <a class="reference internal" href="RadarSystemSupporti.html#applmsghandler"><span class="std std-ref">ApplMsgHandler</span></a>, quando il messaggio di input è di tipo <a class="reference internal" href="#iapplmessage"><span class="std std-ref">IApplMessage</span></a>,
implementato dalla classe <a class="reference internal" href="#applmessage"><span class="std std-ref">ApplMessage</span></a>.</p>
<section id="refactoring-per-il-led">
<h3>Refactoring per il Led<a class="headerlink" href="#refactoring-per-il-led" title="Permalink to this headline">¶</a></h3>
<section id="rafactor-elaborate-di-ledapplinterpreter">
<span id="ledapplintepreterwithctx"></span><h4>rafactor elaborate di <a class="reference internal" href="Enablers.html#ledapplintepreternoctx"><span class="std std-ref">LedApplInterpreter</span></a><a class="headerlink" href="#rafactor-elaborate-di-ledapplinterpreter" title="Permalink to this headline">¶</a></h4>
<p>L’interpretazione dei messaggi inviati al Led distingue ora tra comandi (<em>dispatch</em>) e richieste.
I comandi vengono eseguiti senza produrre risposte, mentre, nel caso di richiesta, viene generato un messaggio
di tipo <a class="reference internal" href="#iapplmessage"><span class="std std-ref">IApplMessage</span></a> usando il metodo <a class="reference internal" href="#preparereply"><span class="std std-ref">prepareReply</span></a>.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LedApplInterpreter</span> <span class="kd">implements</span> <span class="n">IApplInterpreter</span>  <span class="p">{</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">elaborate</span><span class="p">(</span> <span class="n">IApplMessage</span> <span class="n">message</span><span class="p">,</span> <span class="n">Interaction2021</span> <span class="n">conn</span> <span class="p">)</span> <span class="p">{</span>
    <span class="n">String</span> <span class="n">answer</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span> <span class="c1">//no answer</span>
    <span class="k">if</span><span class="p">(</span>  <span class="n">message</span><span class="p">.</span><span class="na">isRequest</span><span class="p">()</span> <span class="p">)</span> <span class="n">answer</span> <span class="o">=</span> <span class="n">elabRequest</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
    <span class="k">else</span> <span class="n">elabCommand</span><span class="p">(</span><span class="n">message</span><span class="p">);</span> <span class="c1">//command =&gt; no answer</span>
    <span class="k">return</span> <span class="n">answer</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">elabCommand</span><span class="p">(</span> <span class="n">IApplMessage</span> <span class="n">message</span> <span class="p">)</span> <span class="p">{</span>
    <span class="n">String</span> <span class="n">payload</span> <span class="o">=</span> <span class="n">message</span><span class="p">.</span><span class="na">msgContent</span><span class="p">();</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">payload</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="s">&quot;on&quot;</span><span class="p">))</span>   <span class="n">led</span><span class="p">.</span><span class="na">turnOn</span><span class="p">();</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">payload</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="s">&quot;off&quot;</span><span class="p">)</span> <span class="p">)</span> <span class="n">led</span><span class="p">.</span><span class="na">turnOff</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="kd">protected</span> <span class="n">String</span> <span class="nf">elabRequest</span><span class="p">(</span> <span class="n">IApplMessage</span> <span class="n">message</span> <span class="p">)</span> <span class="p">{</span>
    <span class="n">String</span> <span class="n">payload</span> <span class="o">=</span> <span class="n">message</span><span class="p">.</span><span class="na">msgContent</span><span class="p">();</span>
    <span class="n">String</span> <span class="n">answer</span>  <span class="o">=</span> <span class="s">&quot;request_unknown&quot;</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">payload</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="s">&quot;getState&quot;</span><span class="p">)</span> <span class="p">)</span> <span class="n">answer</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">+</span><span class="n">led</span><span class="p">.</span><span class="na">getState</span><span class="p">();</span>
    <span class="n">IApplMessage</span> <span class="n">reply</span> <span class="o">=</span> <span class="n">CommUtils</span><span class="p">.</span><span class="na">prepareReply</span><span class="p">(</span> <span class="n">message</span><span class="p">,</span> <span class="n">answer</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">reply</span><span class="p">.</span><span class="na">toString</span><span class="p">()</span> <span class="p">);</span> <span class="c1">//msg(...)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Il metodo <code class="docutils literal notranslate"><span class="pre">elaborate</span></code> di <code class="docutils literal notranslate"><span class="pre">LedApplInterpreter</span></code> viene invocato dal componente applicativo <code class="docutils literal notranslate"><span class="pre">LedApplHandler</span></code>, a sua volta
invocato dall’oggetto di tipo <a class="reference internal" href="RadarSystemProdottiAnalisi.html#interaction2021"><span class="std std-ref">Interaction2021</span></a> creato dal server relativo al protocollo usato.</p>
</section>
<section id="refactor-elaborate-di-ledapplhandler">
<span id="ledapplhandlerwithctx"></span><h4>refactor elaborate di <a class="reference internal" href="Enablers.html#ledapplhandler"><span class="std std-ref">LedApplHandler</span></a><a class="headerlink" href="#refactor-elaborate-di-ledapplhandler" title="Permalink to this headline">¶</a></h4>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LedApplHandler</span> <span class="kd">extends</span> <span class="n">ApplMsgHandler</span> <span class="p">{</span>
  <span class="kd">private</span> <span class="n">IApplInterpreter</span> <span class="n">ledInterpr</span><span class="p">;</span>
  <span class="p">...</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">elaborate</span><span class="p">(</span><span class="n">IApplMessage</span> <span class="n">message</span><span class="p">,</span> <span class="n">Interaction2021</span> <span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">message</span><span class="p">.</span><span class="na">isRequest</span><span class="p">()</span> <span class="p">)</span>
      <span class="n">sendAnswerToClient</span><span class="p">(</span> <span class="n">ledInterpr</span><span class="p">.</span><span class="na">elaborate</span><span class="p">(</span><span class="n">message</span><span class="p">),</span> <span class="n">conn</span> <span class="p">);</span>
    <span class="k">else</span> <span class="n">ledInterpr</span><span class="p">.</span><span class="na">elaborate</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="ledproxy">
<h4>LedProxy<a class="headerlink" href="#ledproxy" title="Permalink to this headline">¶</a></h4>
<p>Come al solito, il proxy traduce invocazioni di metodi in invio di messaggi.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LedProxyAsClient</span> <span class="kd">extends</span> <span class="n">ProxyAsClient</span> <span class="kd">implements</span> <span class="n">ILed</span> <span class="p">{</span>
      <span class="kd">public</span> <span class="kd">static</span>  <span class="n">IApplMessage</span> <span class="n">turnOnLed</span>   <span class="p">;</span>
      <span class="kd">public</span> <span class="kd">static</span>  <span class="n">IApplMessage</span> <span class="n">turnOffLed</span>  <span class="p">;</span>
      <span class="kd">public</span> <span class="kd">static</span>  <span class="n">IApplMessage</span> <span class="n">getLedState</span> <span class="p">;</span>

  <span class="kd">public</span> <span class="nf">LedProxyAsClient</span><span class="p">(</span> <span class="n">String</span> <span class="n">name</span><span class="p">,</span> <span class="n">String</span> <span class="n">host</span><span class="p">,</span> <span class="n">String</span> <span class="n">entry</span><span class="p">,</span>
                     <span class="n">ProtocolType</span> <span class="n">protocol</span>  <span class="p">)</span> <span class="p">{</span>
    <span class="kd">super</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">host</span><span class="p">,</span><span class="n">entry</span><span class="p">,</span> <span class="n">protocol</span><span class="p">);</span>
    <span class="n">turnOnLed</span>   <span class="o">=</span> <span class="n">CommUtils</span><span class="p">.</span><span class="na">buildDispatch</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="s">&quot;cmd&quot;</span><span class="p">,</span> <span class="s">&quot;on&quot;</span><span class="p">,</span>      <span class="s">&quot;led&quot;</span><span class="p">);</span>
    <span class="n">turnOffLed</span>  <span class="o">=</span> <span class="n">CommUtils</span><span class="p">.</span><span class="na">buildDispatch</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="s">&quot;cmd&quot;</span><span class="p">,</span> <span class="s">&quot;off&quot;</span><span class="p">,</span>     <span class="s">&quot;led&quot;</span><span class="p">);</span>
    <span class="n">getLedState</span> <span class="o">=</span> <span class="n">CommUtils</span><span class="p">.</span><span class="na">buildRequest</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;req&quot;</span><span class="p">,</span> <span class="s">&quot;getState&quot;</span><span class="p">,</span><span class="s">&quot;led&quot;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">turnOn</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">protocol</span> <span class="o">==</span> <span class="n">ProtocolType</span><span class="p">.</span><span class="na">tcp</span> <span class="o">||</span> <span class="n">protocol</span> <span class="o">==</span> <span class="n">ProtocolType</span><span class="p">.</span><span class="na">udp</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">sendCommandOnConnection</span><span class="p">(</span><span class="n">turnOnLed</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span>
    <span class="p">}</span>
    <span class="c1">//ALTRI PROTOCOLLI ...</span>
   <span class="p">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">turnOff</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">protocol</span> <span class="o">==</span> <span class="n">ProtocolType</span><span class="p">.</span><span class="na">tcp</span> <span class="o">||</span> <span class="n">protocol</span> <span class="o">==</span> <span class="n">ProtocolType</span><span class="p">.</span><span class="na">udp</span><span class="p">){</span>
      <span class="n">sendCommandOnConnection</span><span class="p">(</span><span class="n">turnOffLed</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span>
    <span class="p">}</span>
    <span class="c1">//ALTRI PROTOCOLLI ...</span>
  <span class="p">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">getState</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">String</span> <span class="n">answer</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">;</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">protocol</span> <span class="o">==</span> <span class="n">ProtocolType</span><span class="p">.</span><span class="na">tcp</span> <span class="o">||</span> <span class="n">protocol</span> <span class="o">==</span> <span class="n">ProtocolType</span><span class="p">.</span><span class="na">udp</span><span class="p">)</span> <span class="p">{</span>
              <span class="n">String</span> <span class="n">reply</span> <span class="o">=</span> <span class="n">sendRequestOnConnection</span><span class="p">(</span> <span class="n">getLedState</span><span class="p">.</span><span class="na">toString</span><span class="p">()</span> <span class="p">);</span>
              <span class="n">answer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ApplMessage</span><span class="p">(</span><span class="n">reply</span><span class="p">).</span><span class="na">msgContent</span><span class="p">();</span>
          <span class="p">}</span>
    <span class="c1">//ALTRI PROTOCOLLI ...</span>
    <span class="k">return</span> <span class="n">answer</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="s">&quot;true&quot;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>I metodi <code class="docutils literal notranslate"><span class="pre">sendCommandOnConnection</span></code> e <code class="docutils literal notranslate"><span class="pre">sendRequestOnConnection</span></code> sono definiti in <a class="reference internal" href="RadarSystemSupporti.html#proxyasclient"><span class="std std-ref">ProxyAsClient</span></a>
e usano al connessione <a class="reference internal" href="RadarSystemProdottiAnalisi.html#interaction2021"><span class="std std-ref">Interaction2021</span></a>.</p>
<p>Pertanto l’invio di una richiesta da parte del Proxy viene subito seguito da un attesa della ricezione
della risposta, che consiste in un messaggio strutturato creato mediante <a class="reference internal" href="#preparereply"><span class="std std-ref">prepareReply</span></a>.</p>
</section>
</section>
<section id="refactoring-per-il-sonar">
<h3>Refactoring per il Sonar<a class="headerlink" href="#refactoring-per-il-sonar" title="Permalink to this headline">¶</a></h3>
<section id="rafactor-elaborate-di-sonarapplinterpreter">
<span id="sonarapplintepreterwithctx"></span><h4>rafactor elaborate di <a class="reference internal" href="Enablers.html#sonarapplintepreternoctx"><span class="std std-ref">SonarApplInterpreter</span></a><a class="headerlink" href="#rafactor-elaborate-di-sonarapplinterpreter" title="Permalink to this headline">¶</a></h4>
<p>L’interpretazione dei messaggi inviati al Led distingue ora tra comandi (<em>dispatch</em>) e richieste.
I comandi vengono eseguiti senza produrre risposte, mentre, nel caso di richiesta, viene generato un messaggio
di tipo <a class="reference internal" href="#iapplmessage"><span class="std std-ref">IApplMessage</span></a> usando il metodo <a class="reference internal" href="#preparereply"><span class="std std-ref">prepareReply</span></a>.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SonarApplInterpreter</span> <span class="kd">implements</span> <span class="n">IApplInterpreter</span><span class="p">{</span>
<span class="kd">private</span>       <span class="n">ISonar</span> <span class="n">sonar</span><span class="p">;</span>
  <span class="p">...</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">String</span> <span class="nf">elaborate</span><span class="p">(</span><span class="n">IApplMessage</span> <span class="n">message</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">String</span> <span class="n">answer</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span> <span class="c1">//no answer</span>
      <span class="k">if</span><span class="p">(</span>  <span class="n">message</span><span class="p">.</span><span class="na">isRequest</span><span class="p">()</span> <span class="p">)</span>  <span class="n">answer</span> <span class="o">=</span> <span class="n">elabRequest</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
      <span class="k">else</span> <span class="n">elabCommand</span><span class="p">(</span><span class="n">message</span><span class="p">);</span> <span class="c1">//command =&gt; no answer</span>
      <span class="k">return</span> <span class="n">answer</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">elabCommand</span><span class="p">(</span> <span class="n">IApplMessage</span> <span class="n">message</span> <span class="p">)</span> <span class="p">{</span>
    <span class="n">String</span> <span class="n">payload</span> <span class="o">=</span> <span class="n">message</span><span class="p">.</span><span class="na">msgContent</span><span class="p">();</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">payload</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="s">&quot;activate&quot;</span><span class="p">))</span> <span class="n">sonar</span><span class="p">.</span><span class="na">activate</span><span class="p">();</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">payload</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="s">&quot;deactivate&quot;</span><span class="p">))</span> <span class="n">sonar</span><span class="p">.</span><span class="na">deactivate</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="kd">protected</span> <span class="n">String</span> <span class="nf">elabRequest</span><span class="p">(</span> <span class="n">IApplMessage</span> <span class="n">message</span> <span class="p">)</span> <span class="p">{</span>
    <span class="n">String</span> <span class="n">answer</span>  <span class="o">=</span> <span class="s">&quot;request_unknown&quot;</span><span class="p">;</span>
    <span class="n">String</span> <span class="n">payload</span> <span class="o">=</span> <span class="n">message</span><span class="p">.</span><span class="na">msgContent</span><span class="p">();</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">payload</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="s">&quot;getDistance&quot;</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">answer</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">+</span><span class="n">sonar</span><span class="p">.</span><span class="na">getDistance</span><span class="p">().</span><span class="na">getVal</span><span class="p">();</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">payload</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="s">&quot;isActive&quot;</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">answer</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">+</span><span class="n">sonar</span><span class="p">.</span><span class="na">isActive</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="n">IApplMessage</span> <span class="n">reply</span> <span class="o">=</span> <span class="n">CommUtils</span><span class="p">.</span><span class="na">prepareReply</span><span class="p">(</span> <span class="n">message</span><span class="p">,</span> <span class="n">answer</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">reply</span><span class="p">.</span><span class="na">toString</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Il metodo <code class="docutils literal notranslate"><span class="pre">elaborate</span></code> di <code class="docutils literal notranslate"><span class="pre">SonarApplInterpreter</span></code> viene invocato dal componente applicativo <code class="docutils literal notranslate"><span class="pre">SonarApplHandler</span></code>, a sua volta
invocato dall’oggetto di tipo <a class="reference internal" href="RadarSystemProdottiAnalisi.html#interaction2021"><span class="std std-ref">Interaction2021</span></a> creato dal server relativo al protocollo usato.</p>
</section>
<section id="refactor-elaborate-di-sonarapplhandler">
<span id="sonarapplhandlerwithctx"></span><h4>refactor elaborate di <a class="reference internal" href="Enablers.html#sonarapplhandler"><span class="std std-ref">SonarApplHandler</span></a><a class="headerlink" href="#refactor-elaborate-di-sonarapplhandler" title="Permalink to this headline">¶</a></h4>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SonarApplHandler</span> <span class="kd">extends</span> <span class="n">ApplMsgHandler</span> <span class="p">{</span>
<span class="kd">private</span> <span class="n">IApplInterpreter</span> <span class="n">sonarIntepr</span><span class="p">;</span>
<span class="p">...</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">elaborate</span><span class="p">(</span> <span class="n">IApplMessage</span> <span class="n">message</span><span class="p">,</span> <span class="n">Interaction2021</span> <span class="n">conn</span> <span class="p">){</span>
  <span class="k">if</span><span class="p">(</span> <span class="n">message</span><span class="p">.</span><span class="na">isRequest</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
      <span class="n">String</span> <span class="n">answer</span> <span class="o">=</span> <span class="n">sonarIntepr</span><span class="p">.</span><span class="na">elaborate</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
      <span class="n">sendAnswerToClient</span><span class="p">(</span> <span class="n">answer</span><span class="p">,</span> <span class="n">conn</span> <span class="p">);</span>
  <span class="p">}</span><span class="k">else</span> <span class="n">sonarIntepr</span><span class="p">.</span><span class="na">elaborate</span><span class="p">(</span> <span class="n">message</span><span class="p">.</span><span class="na">msgContent</span><span class="p">()</span> <span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="sonarproxy">
<h4>SonarProxy<a class="headerlink" href="#sonarproxy" title="Permalink to this headline">¶</a></h4>
<p>Come al solito, il proxy traduce invocazioni di metodi in invio di messaggi.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SonarProxyAsClient</span> <span class="kd">extends</span> <span class="n">ProxyAsClient</span> <span class="kd">implements</span> <span class="n">ISonar</span><span class="p">{</span>
  <span class="kd">public</span> <span class="kd">static</span>    <span class="n">IApplMessage</span> <span class="n">sonarActivate</span>   <span class="p">;</span>
  <span class="kd">public</span> <span class="kd">static</span>    <span class="n">IApplMessage</span> <span class="n">sonarDeactivate</span> <span class="p">;</span>
  <span class="kd">public</span> <span class="kd">static</span>    <span class="n">IApplMessage</span> <span class="n">getDistance</span>  <span class="p">;</span>
  <span class="kd">public</span> <span class="kd">static</span>    <span class="n">IApplMessage</span> <span class="n">isActive</span>     <span class="p">;</span>

  <span class="kd">public</span> <span class="nf">SonarProxyAsClient</span><span class="p">(</span>
      <span class="n">String</span> <span class="n">name</span><span class="p">,</span> <span class="n">String</span> <span class="n">host</span><span class="p">,</span> <span class="n">String</span> <span class="n">entry</span><span class="p">,</span> <span class="n">ProtocolType</span> <span class="n">protocol</span> <span class="p">)</span> <span class="p">{</span>
    <span class="kd">super</span><span class="p">(</span> <span class="n">name</span><span class="p">,</span>  <span class="n">host</span><span class="p">,</span>  <span class="n">entry</span><span class="p">,</span> <span class="n">protocol</span> <span class="p">);</span>
    <span class="n">sonarActivate</span>   <span class="o">=</span>
      <span class="n">CommUtils</span><span class="p">.</span><span class="na">buildDispatch</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="s">&quot;cmd&quot;</span><span class="p">,</span> <span class="s">&quot;activate&quot;</span><span class="p">,</span>   <span class="s">&quot;sonar&quot;</span><span class="p">);</span>
    <span class="n">sonarDeactivate</span> <span class="o">=</span>
      <span class="n">CommUtils</span><span class="p">.</span><span class="na">buildDispatch</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="s">&quot;cmd&quot;</span><span class="p">,</span> <span class="s">&quot;deactivate&quot;</span><span class="p">,</span> <span class="s">&quot;sonar&quot;</span><span class="p">);</span>
    <span class="n">getDistance</span>     <span class="o">=</span>
      <span class="n">CommUtils</span><span class="p">.</span><span class="na">buildRequest</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;req&quot;</span><span class="p">,</span> <span class="s">&quot;getDistance&quot;</span><span class="p">,</span><span class="s">&quot;sonar&quot;</span><span class="p">);</span>
    <span class="n">isActive</span>        <span class="o">=</span>
      <span class="n">CommUtils</span><span class="p">.</span><span class="na">buildRequest</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;req&quot;</span><span class="p">,</span> <span class="s">&quot;isActive&quot;</span><span class="p">,</span>   <span class="s">&quot;sonar&quot;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">activate</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">protocol</span> <span class="o">==</span> <span class="n">ProtocolType</span><span class="p">.</span><span class="na">tcp</span> <span class="o">||</span> <span class="n">protocol</span> <span class="o">==</span> <span class="n">ProtocolType</span><span class="p">.</span><span class="na">udp</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">sendCommandOnConnection</span><span class="p">(</span><span class="n">sonarActivate</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span>
    <span class="p">}</span>
    <span class="c1">//ALTRI PROTOCOLLI ...</span>
  <span class="p">}</span>
  <span class="p">...</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isActive</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">String</span> <span class="n">answer</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">protocol</span> <span class="o">==</span> <span class="n">ProtocolType</span><span class="p">.</span><span class="na">tcp</span> <span class="o">||</span> <span class="n">protocol</span> <span class="o">==</span> <span class="n">ProtocolType</span><span class="p">.</span><span class="na">udp</span><span class="p">)</span> <span class="p">{</span>
              <span class="n">String</span> <span class="n">reply</span> <span class="o">=</span> <span class="n">sendRequestOnConnection</span><span class="p">(</span> <span class="n">isActive</span><span class="p">.</span><span class="na">toString</span><span class="p">()</span> <span class="p">);</span>
              <span class="n">answer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ApplMessage</span><span class="p">(</span><span class="n">reply</span><span class="p">).</span><span class="na">msgContent</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">answer</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span> <span class="s">&quot;true&quot;</span> <span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>I metodi <code class="docutils literal notranslate"><span class="pre">sendCommandOnConnection</span></code> e <code class="docutils literal notranslate"><span class="pre">sendRequestOnConnection</span></code> sono definiti in <a class="reference internal" href="RadarSystemSupporti.html#proxyasclient"><span class="std std-ref">ProxyAsClient</span></a>
e usano al connessione <a class="reference internal" href="RadarSystemProdottiAnalisi.html#interaction2021"><span class="std std-ref">Interaction2021</span></a>.</p>
<p>Pertanto l’invio di una richiesta da parte del Proxy viene subito seguito da un attesa della ricezione
della risposta, che consiste in un messaggio strutturato creato mediante <a class="reference internal" href="#preparereply"><span class="std std-ref">prepareReply</span></a>.</p>
</section>
</section>
<section id="architettura-con-contesto">
<h3>Architettura con contesto<a class="headerlink" href="#architettura-con-contesto" title="Permalink to this headline">¶</a></h3>
<p>Avvalendoci dei componenti introdotti in precedenza, costruiamo un sistema che abbia  i dispositivi sul Raspberry
e la business logic su PC.</p>
<p>Ad esempio, la figura che segue illuistra l’architettura di un sistema che
pone sul PC un gestore del Led remoto (si veda la classe <code class="docutils literal notranslate"><span class="pre">UseLedFromPc.java</span></code>).</p>
<a class="reference internal image-reference" href="_images/LedUsageWithCtx.PNG"><img alt="_images/LedUsageWithCtx.PNG" class="align-center" src="_images/LedUsageWithCtx.PNG" style="width: 80%;" /></a>
<p>Il package <code class="docutils literal notranslate"><span class="pre">it.unibo.radarSystem22_4.appl.main</span></code> contiene i seguenti programmi</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">RadarSystemMainDevsCtxOnRasp</span></code> :  attiva il contesto e i dispositivi su Raspberry</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">UseLedFromPc</span></code> : invia da PC comandi e richieste relative al Led; è usabile come tester</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">UseSonarFromPc</span></code> : invia da PC comandi e richieste relative al Sonar; è usabile come tester</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">RadarSystemMainWithCtxOnPc</span></code> : attiva Controller e radar sul PC</p></li>
</ul>
</section>
<section id="deployoment-del-prototipo-con-contesto">
<h3>Deployoment del prototipo con contesto<a class="headerlink" href="#deployoment-del-prototipo-con-contesto" title="Permalink to this headline">¶</a></h3>
<p>Simile a quanto fatto in <a class="reference internal" href="RadarSystemProgetto.html#sprint1-deployment-su-raspberrypi"><span class="std std-ref">SPRINT1: Deployment su RaspberryPi</span></a>. Il comando:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">gradle</span> <span class="n">distZip</span> <span class="n">jar</span> <span class="o">-</span><span class="n">x</span> <span class="n">test</span>
</pre></div>
</div>
<p>crea il file <cite>builddistributionsit.unibo.radarSystem22_4-1.0.zip</cite>.</p>
</section>
</section>
<section id="sprint4-esperimenti">
<h2>Sprint4: esperimenti<a class="headerlink" href="#sprint4-esperimenti" title="Permalink to this headline">¶</a></h2>
<p><span class="worktodo">WORKTODO: eseguire gli esperimenti qui di seguito indicati</span></p>
<ol class="arabic simple">
<li><p>osservazione del numero di Thread creati nel RadarSystem su RaspberryPi</p></li>
<li><p>verificare le conseguenze di un handler applicativo che si blocca</p></li>
<li><p>usare l’operazione  <a class="reference internal" href="#preparereply"><span class="std std-ref">prepareReply</span></a>  per la creazione di risposte</p></li>
<li><p>inviare due  richieste ‘in parallelo’ a un componente che le esegue in thread diversi</p></li>
<li><p>l’uso di un  Contatore con delay</p></li>
</ol>
<section id="richieste-in-parallelo">
<h3>Richieste ‘in parallelo’<a class="headerlink" href="#richieste-in-parallelo" title="Permalink to this headline">¶</a></h3>
<p>Un oggetto istanza di <code class="docutils literal notranslate"><span class="pre">RequestHandler</span></code> (package <em>it.unibo.radarSystem22_4.appl.handler</em>)
implementa <a class="reference internal" href="RadarSystemSupporti.html#iapplmsghandler"><span class="std std-ref">IApplMsgHandler</span></a> nel modo che segue:</p>
<ul class="simple">
<li><p>alla ricezione di un messaggio di richiesta, attiva un nuovo Thread, cui affida l’elaborazione
del messaggio e l’invio della risposta usando il metodo <a class="reference internal" href="#preparereply"><span class="std std-ref">prepareReply</span></a>;</p></li>
<li><p>se la richiesta ricevuta è la prima, simula una valutazione che dura un certo tempo
e poi invia la risposta;</p></li>
<li><p>se la rchiesta non è la prima, invia subito la risposta.</p></li>
</ul>
<p>Il programma <code class="docutils literal notranslate"><span class="pre">ReplyProblem</span></code> (package <em>it.unibo.radarSystem22_4.appl.main</em>) opera come segue:</p>
<ul>
<li><p>definisce un contesto di nodo (basato su <code class="docutils literal notranslate"><span class="pre">TCP</span></code>) in cui inserisce come componente
una istanza di <code class="docutils literal notranslate"><span class="pre">RequestHandler</span></code> di nome <strong>rh1</strong>;</p></li>
<li><p>definisce un proxy <code class="docutils literal notranslate"><span class="pre">pxy</span></code> per inviare messaggi al contesto;</p></li>
<li><p>crea due Thread, ciascuno dei quali usa <code class="docutils literal notranslate"><span class="pre">pxy</span></code> per inviare la richiesta che segue:</p>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">msg</span><span class="p">(</span><span class="n">req</span><span class="p">,</span><span class="n">request</span><span class="p">,</span><span class="n">thread1</span><span class="p">,</span><span class="n">rh1</span><span class="p">,</span><span class="n">r1</span><span class="p">,</span><span class="n">N1</span><span class="p">)</span>   <span class="n">primo</span> <span class="n">Thread</span>
<span class="nf">msg</span><span class="p">(</span><span class="n">req</span><span class="p">,</span><span class="n">request</span><span class="p">,</span><span class="n">thread2</span><span class="p">,</span><span class="n">rh1</span><span class="p">,</span><span class="n">r2</span><span class="p">,</span><span class="n">N2</span><span class="p">)</span>   <span class="n">secondo</span> <span class="n">Thread</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
<p>In questo modo, sulla connessione stabilita dal <code class="docutils literal notranslate"><span class="pre">pxy</span></code> vengono trasmesse due richieste allo stesso
componente <strong>rh1</strong>, il quale invia per prima la risposta alla seconda richiesta.
Poichè la connessione è la stessa per ciascuno dei due Thread mittenti,
il secondo Thread riceve come risposta un messaggio che dovrebbe giungere al primo
Thread:</p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">msg(req,reply,rh1,thread1,r1_done,N)</span></code></p>
</div></blockquote>
</section>
<section id="uso-di-un-counterwithdelay">
<h3>Uso di un CounterWithDelay<a class="headerlink" href="#uso-di-un-counterwithdelay" title="Permalink to this headline">¶</a></h3>
<p>Nel caso di <strong>componenti con stato</strong> utlizzabili da più clienti, vi possono essere problemi di concorrenza.</p>
<p>Per un esempio, si consideri un contatore (POJO) che effettua una operazione di decremento rilasciando il controllo
prima del completamento della operazione.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CounterWithDelay</span> <span class="p">{</span>
  <span class="kd">private</span> <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">inc</span><span class="p">()</span> <span class="p">{</span> <span class="n">n</span> <span class="o">=</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="p">}</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">dec</span><span class="p">(</span><span class="kt">int</span> <span class="n">dt</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">v</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">ColorsOut</span><span class="p">.</span><span class="na">delay</span><span class="p">(</span><span class="n">dt</span><span class="p">);</span>  <span class="c1">//the control is given to another thread</span>
    <span class="n">ColorsOut</span><span class="p">.</span><span class="na">out</span><span class="p">(</span><span class="s">&quot;Counter resumes v= &quot;</span> <span class="o">+</span> <span class="n">v</span><span class="p">);</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
    <span class="n">ColorsOut</span><span class="p">.</span><span class="na">out</span><span class="p">(</span><span class="s">&quot;Counter new value after dec= &quot;</span> <span class="o">+</span> <span class="n">n</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>La chiamata al contatore può essere effettuata da un Proxy che invia un messaggio</p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">msg(</span> <span class="pre">cmd,</span> <span class="pre">dispatch,</span> <span class="pre">main,</span> <span class="pre">counter,</span> <span class="pre">dec(DELAY),</span> <span class="pre">1)</span></code></p>
</div></blockquote>
<p>con <code class="docutils literal notranslate"><span class="pre">DELAY</span></code> fissato a un certo valore. Ad esempio:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">String</span> <span class="n">delay</span> <span class="o">=</span> <span class="s">&quot;50&quot;</span><span class="p">;</span>
<span class="n">ApplMessage</span> <span class="n">msgDec</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ApplMessage</span><span class="p">(</span>
    <span class="s">&quot;msg( dec, dispatch, main, counter, dec(DELAY), 1)&quot;</span>
    <span class="p">.</span><span class="na">replace</span><span class="p">(</span><span class="s">&quot;DELAY&quot;</span><span class="p">,</span> <span class="n">delay</span><span class="p">));</span>
<span class="n">ProxyAsClient</span> <span class="n">client1</span> <span class="o">=</span>
    <span class="k">new</span> <span class="n">ProxyAsClient</span><span class="p">(</span><span class="s">&quot;client1&quot;</span><span class="p">,</span><span class="s">&quot;localhost&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="o">+</span><span class="n">ctxServerPort</span><span class="p">,</span><span class="n">ProtocolType</span><span class="p">.</span><span class="na">tcp</span><span class="p">).</span>
<span class="n">client1</span><span class="p">.</span><span class="na">sendCommandOnConnection</span><span class="p">(</span><span class="n">msgDec</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="_images/CounterDelayHandler.PNG"><img alt="_images/CounterDelayHandler.PNG" class="align-center" src="_images/CounterDelayHandler.PNG" style="width: 70%;" /></a>
<p>Il <code class="docutils literal notranslate"><span class="pre">CounterWithDelay</span></code> è incapsulato in un handler che, al solito, gestisce i messaggi
che gli vengono pasati dalla infrastruttura e, nel caso di una richiesta, invia la
risposta al chiamanete:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CounterApplHandler</span> <span class="kd">extends</span> <span class="n">ApplMsgHandler</span> <span class="p">{</span>
<span class="kd">private</span> <span class="n">CounterWithDelay</span> <span class="n">counter</span><span class="p">;</span>

<span class="kd">public</span> <span class="nf">CounterApplHandler</span><span class="p">(</span> <span class="n">String</span> <span class="n">name</span> <span class="p">)</span> <span class="p">{</span>
  <span class="kd">super</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="na">counter</span> <span class="o">=</span> <span class="n">counter</span><span class="p">;</span>
<span class="p">}</span>

<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">elaborate</span><span class="p">(</span><span class="n">IApplMessage</span> <span class="n">message</span><span class="p">,</span> <span class="n">Interaction2021</span> <span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">String</span> <span class="n">answer</span><span class="o">=</span><span class="kc">null</span><span class="p">;</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="n">String</span> <span class="n">cmd</span> <span class="o">=</span>  <span class="n">msg</span><span class="p">.</span><span class="na">msgContent</span><span class="p">();</span>
    <span class="kt">int</span> <span class="n">delay</span>   <span class="o">=</span> <span class="n">getDecDelayArg</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
    <span class="n">counter</span><span class="p">.</span><span class="na">dec</span><span class="p">(</span><span class="n">delay</span><span class="p">);</span>
    <span class="n">answer</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">+</span><span class="n">counter</span><span class="p">.</span><span class="na">getVal</span><span class="p">();</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">msg</span><span class="p">.</span><span class="na">isRequest</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
      <span class="n">IApplMessage</span>  <span class="n">reply</span> <span class="o">=</span> <span class="n">CommUtils</span><span class="p">.</span><span class="na">prepareReply</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">answer</span><span class="p">);</span>
      <span class="n">sendAnswerToClient</span><span class="p">(</span><span class="n">reply</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span>
    <span class="p">}</span>
  <span class="p">}</span><span class="k">catch</span><span class="p">(</span> <span class="n">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Il messaggio ricevuto ha la forma che segue:</p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">msg(</span> <span class="pre">dec,</span> <span class="pre">dispatch,</span> <span class="pre">main,</span> <span class="pre">counter,</span> <span class="pre">dec(DELAY),</span> <span class="pre">1)</span></code></p>
</div></blockquote>
<p>Quindi il payload è una String che denota un termine Prolog</p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">dec(DELAY)</span></code></p>
</div></blockquote>
<p>Il metodo <code class="docutils literal notranslate"><span class="pre">getDecDelayArg</span></code> restituisce il valore di DELAY secondo quanto discusso
in <a class="reference internal" href="#accesso-al-payload-usando-prolog">accesso al payload usando Prolog</a></p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">protected</span> <span class="kt">int</span> <span class="nf">getDecDelayArg</span><span class="p">(</span><span class="n">String</span> <span class="n">cmd</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="p">{</span>
  <span class="n">Struct</span> <span class="n">cmdT</span>     <span class="o">=</span> <span class="p">(</span><span class="n">Struct</span><span class="p">)</span> <span class="n">Term</span><span class="p">.</span><span class="na">createTerm</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
  <span class="n">String</span> <span class="n">cmdName</span>  <span class="o">=</span> <span class="n">cmdT</span><span class="p">.</span><span class="na">getName</span><span class="p">();</span>
  <span class="k">if</span><span class="p">(</span> <span class="n">cmdName</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="s">&quot;dec&quot;</span><span class="p">))</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">delay</span> <span class="o">=</span> <span class="n">Integer</span><span class="p">.</span><span class="na">parseInt</span><span class="p">(</span><span class="n">cmdT</span><span class="p">.</span><span class="na">getArg</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="na">toString</span><span class="p">());</span>
    <span class="k">return</span> <span class="n">delay</span><span class="p">;</span>
  <span class="p">}</span><span class="k">else</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Il programma <code class="docutils literal notranslate"><span class="pre">SharedCounterExampleMain</span></code> crea due chiamate una di seguito all’altra.
Con delay basso (ad esempio <code class="docutils literal notranslate"><span class="pre">delay=&quot;0&quot;;</span></code>) il comportamento è corretto (e il contatore va a 0),
ma con <code class="docutils literal notranslate"><span class="pre">delay=&quot;50&quot;;</span></code> si vede che il decremento non avviene (il contatore si fissa a 1).</p>
<p>Questi problemi possono essere evitati sostituendo il POJO <code class="docutils literal notranslate"><span class="pre">CounterWithDelay</span></code> con un
attore:</p>
<a class="reference internal image-reference" href="_images/CounterWithDelayActor.PNG"><img alt="_images/CounterWithDelayActor.PNG" class="align-center" src="_images/CounterWithDelayActor.PNG" style="width: 70%;" /></a>
</section>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="index.html">
    <img class="logo" src="_static/logo-unibo.gif" alt="Logo"/>
    
    <h1 class="logo logo-name">iss22</h1>
    
  </a>
</p>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="Introduzione.html">Introduzione</a></li>
<li class="toctree-l1"><a class="reference internal" href="CostruireSoftware.html">Costruire software</a></li>
<li class="toctree-l1"><a class="reference internal" href="WorkspaceSetup.html">WorkspaceSetup</a></li>
<li class="toctree-l1"><a class="reference internal" href="RadarSystem.html">RadarSystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="RadarSystemAnalisi.html">Analisi del problema</a></li>
<li class="toctree-l1"><a class="reference internal" href="RadarSystemProdottiAnalisi.html">Prodotti della analisi</a></li>
<li class="toctree-l1"><a class="reference internal" href="RadarSystemProgetto.html">Progettazione e sviluppo</a></li>
<li class="toctree-l1"><a class="reference internal" href="RadarSystemSupporti.html">Supporti per comunicazioni</a></li>
<li class="toctree-l1"><a class="reference internal" href="Enablers.html">Abilitatori di comunicazione</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Contesti-contenitori</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#analisi-del-concetto-di-contesto">Analisi del concetto di Contesto</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#icontext">IContext</a></li>
<li class="toctree-l3"><a class="reference internal" href="#struttura-dei-messaggi-applicativi">Struttura dei messaggi applicativi</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#rappresentazione-dei-messaggi">Rappresentazione dei messaggi</a></li>
<li class="toctree-l4"><a class="reference internal" href="#iapplmessage">IApplMessage</a></li>
<li class="toctree-l4"><a class="reference internal" href="#il-problema-delle-risposte">Il problema delle risposte</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#lo-sprint4">Lo SPRINT4</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#sprint4-il-progetto-del-systemdesigner">SPRINT4: il progetto del SystemDesigner</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#la-classe-applmessage">La classe ApplMessage</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#il-metodo-setfields">Il metodo setFields</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#perche-prolog">Perchè Prolog?</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#estensione-della-interfaccia-iapplmsghandler">Estensione della interfaccia <span class="xref std std-ref">IApplMsgHandler</span></a></li>
<li class="toctree-l4"><a class="reference internal" href="#estensione-della-interfaccia-iapplintepreter">Estensione della interfaccia <span class="xref std std-ref">IApplIntepreter</span></a></li>
<li class="toctree-l4"><a class="reference internal" href="#modifica-della-classe-applmsghandler">Modifica della classe <span class="xref std std-ref">ApplMsgHandler</span></a><ul>
<li class="toctree-l5"><a class="reference internal" href="#metodo-preparereply">Metodo <code class="docutils literal notranslate"><span class="pre">prepareReply</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#abilitatore-di-contesto">Abilitatore di contesto</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#enablercontext">EnablerContext</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#il-gestore-di-sistema-dei-messaggi">Il gestore di sistema dei messaggi</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#verso-gli-attori">Verso gli attori</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#sprint4-il-progetto-dell-applicationdesigner">SPRINT4: il progetto dell’ ApplicationDesigner</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#refactoring-per-il-led">Refactoring per il Led</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#rafactor-elaborate-di-ledapplinterpreter">rafactor elaborate di <span class="xref std std-ref">LedApplInterpreter</span></a></li>
<li class="toctree-l4"><a class="reference internal" href="#refactor-elaborate-di-ledapplhandler">refactor elaborate di <span class="xref std std-ref">LedApplHandler</span></a></li>
<li class="toctree-l4"><a class="reference internal" href="#ledproxy">LedProxy</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#refactoring-per-il-sonar">Refactoring per il Sonar</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#rafactor-elaborate-di-sonarapplinterpreter">rafactor elaborate di <span class="xref std std-ref">SonarApplInterpreter</span></a></li>
<li class="toctree-l4"><a class="reference internal" href="#refactor-elaborate-di-sonarapplhandler">refactor elaborate di <span class="xref std std-ref">SonarApplHandler</span></a></li>
<li class="toctree-l4"><a class="reference internal" href="#sonarproxy">SonarProxy</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#architettura-con-contesto">Architettura con contesto</a></li>
<li class="toctree-l3"><a class="reference internal" href="#deployoment-del-prototipo-con-contesto">Deployoment del prototipo con contesto</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#sprint4-esperimenti">Sprint4: esperimenti</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#richieste-in-parallelo">Richieste ‘in parallelo’</a></li>
<li class="toctree-l3"><a class="reference internal" href="#uso-di-un-counterwithdelay">Uso di un CounterWithDelay</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="SonarObservable.html">Il SonarObservable</a></li>
<li class="toctree-l1"><a class="reference internal" href="Attori.html">Attori</a></li>
<li class="toctree-l1"><a class="reference internal" href="RaspberrySoftware.html">RaspberrySoftware</a></li>
<li class="toctree-l1"><a class="reference internal" href="RaspBasicCode.html">RaspBasicCode</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="Enablers.html" title="previous chapter">Abilitatori di comunicazione</a></li>
      <li>Next: <a href="SonarObservable.html" title="next chapter">Il SonarObservable</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2021, Antonio Natali.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.4.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="_sources/ContestiContenitori.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>